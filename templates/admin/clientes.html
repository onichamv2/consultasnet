{% extends 'base.html' %}

{% block title %}Clientes{% endblock %}

{% block content %}
<h1 class="mb-4 fw-bold">Clientes</h1>

<button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#nuevoClienteModal">
  + Nuevo Cliente
</button>

<table class="table table-bordered">
  <thead class="table-dark text-center">
    <tr>
      <th>ID</th>
      <th>Nombre</th>
      <th>TelÃ©fono</th>
      <th>Cantidad</th>
      <th>PIN</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody class="text-center">
    {% for cliente, cuentas_count in clientes %}
    <tr>
      <td>{{ cliente.id }}</td>
      <td>{{ cliente.nombre }}</td>
      <td>{{ cliente.telefono }}</td>
      <td>
        <span class="badge bg-secondary">{{ cuentas_count }}</span>
      </td>
      <td>
        <span id="pin-{{ cliente.id }}">{{ cliente.pin_restablecer or '----' }}</span>
        <button onclick="generarPin({{ cliente.id }})" class="btn btn-sm btn-light">
          Generar PIN
        </button>
      </td>
      <td>
        <!-- BotÃ³n Editar -->
        <button 
          class="btn btn-warning btn-sm open-edit-cliente"
          data-id="{{ cliente.id }}">
          Editar
        </button>

        <!-- BotÃ³n Ver Cuentas -->
        <a href="{{ url_for('panel.cuentas_cliente', cliente_id=cliente.id) }}" class="btn btn-primary btn-sm">
          Ver Cuentas
        </a>

        <!-- âœ… BotÃ³n Reportar por WhatsApp -->
        <a href="{{ url_for('panel.reportar_cuentas', cliente_id=cliente.id) }}"
          class="btn btn-success btn-sm"
          target="_blank"
          rel="noopener noreferrer">
          ðŸ“¤ Reportar
        </a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- âœ… Modal Editar Cliente -->
<!-- âœ… Modal NUEVO Cliente -->
<div class="modal fade" id="nuevoClienteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="nuevoClienteForm">
        <div class="modal-header">
          <h5 class="modal-title">Nuevo Cliente</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label>Nombre</label>
            <input type="text" id="nuevoClienteNombre" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>TelÃ©fono</label>
            <input type="text" id="nuevoClienteTelefono" class="form-control" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Guardar</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
  const nuevoClienteModal = new bootstrap.Modal(document.getElementById('nuevoClienteModal'));
  const nuevoClienteForm = document.getElementById('nuevoClienteForm');

  nuevoClienteForm.addEventListener('submit', (e) => {
    e.preventDefault();

    fetch('/panel/api/cliente/nuevo', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        nombre: document.getElementById('nuevoClienteNombre').value,
        telefono: document.getElementById('nuevoClienteTelefono').value
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert('Error al crear');
      }
    });
  });
</script>

{% endblock %}
