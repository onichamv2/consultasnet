{% extends 'base.html' %}

{% block title %}Clientes{% endblock %}

{% block content %}
<h1 class="mb-4 fw-bold">Clientes</h1>

<a href="{{ url_for('panel.nuevo_cliente') }}" class="btn btn-primary mb-3">
  + Nuevo Cliente
</a>

<table class="table table-bordered">
  <thead class="table-dark text-center">
    <tr>
      <th>ID</th>
      <th>Nombre</th>
      <th>Tel√©fono</th>
      <th>Cantidad</th>
      <th>PIN</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody class="text-center">
    {% for cliente, cuentas_count in clientes %}
    <tr>
      <td>{{ cliente.id }}</td>
      <td>{{ cliente.nombre }}</td>
      <td>{{ cliente.telefono }}</td>
      <td>
        <span class="badge bg-secondary">{{ cuentas_count }}</span>
      </td>
      <td>
        <span id="pin-{{ cliente.id }}">{{ cliente.pin_restablecer or '----' }}</span>
        <button onclick="generarPin({{ cliente.id }})" class="btn btn-sm btn-light">
          Generar PIN
        </button>
      </td>
      <td>
        <!-- Bot√≥n Editar -->
        <button 
          class="btn btn-warning btn-sm open-edit-cliente"
          data-id="{{ cliente.id }}">
          Editar
        </button>

        <!-- Bot√≥n Ver Cuentas -->
        <a href="{{ url_for('panel.cuentas_cliente', cliente_id=cliente.id) }}" class="btn btn-primary btn-sm">
          Ver Cuentas
        </a>

        <!-- ‚úÖ Bot√≥n Reportar por WhatsApp -->
        <a href="{{ url_for('panel.reportar_cuentas', cliente_id=cliente.id) }}"
          class="btn btn-success btn-sm"
          target="_blank"
          rel="noopener noreferrer">
          üì§ Reportar
        </a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- ‚úÖ Modal Editar Cliente -->
<div class="modal fade" id="editClienteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="editClienteForm">
        <div class="modal-header">
          <h5 class="modal-title">Editar Cliente</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="clienteId">
          <div class="mb-3">
            <label>Nombre</label>
            <input type="text" id="clienteNombre" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>Tel√©fono</label>
            <input type="text" id="clienteTelefono" class="form-control" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Guardar Cambios</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  const editClienteModal = new bootstrap.Modal(document.getElementById('editClienteModal'));
  const editClienteForm = document.getElementById('editClienteForm');

  // Abrir modal con datos del cliente
  document.querySelectorAll('.open-edit-cliente').forEach(button => {
    button.addEventListener('click', () => {
      const clienteId = button.dataset.id;

      fetch(`/panel/api/cliente/${clienteId}`)
        .then(response => response.json())
        .then(data => {
          document.getElementById('clienteId').value = data.id;
          document.getElementById('clienteNombre').value = data.nombre;
          document.getElementById('clienteTelefono').value = data.telefono;
          editClienteModal.show();
        });
    });
  });

  // Guardar cambios por AJAX
  editClienteForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const clienteId = document.getElementById('clienteId').value;

    fetch(`/panel/api/cliente/${clienteId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        nombre: document.getElementById('clienteNombre').value,
        telefono: document.getElementById('clienteTelefono').value
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert('Error al guardar');
      }
    });
  });

  // ‚úÖ Nuevo: Generar PIN sin recargar
  function generarPin(clienteId) {
    fetch(`/panel/api/cliente/${clienteId}/generar_pin`, { method: 'POST' })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          document.getElementById(`pin-${clienteId}`).innerText = data.nuevo_pin;
        } else {
          alert("‚ùå Error generando PIN");
        }
      });
  }
</script>
{% endblock %}
